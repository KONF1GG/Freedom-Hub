#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-server.sh yourdomain.com

if [ -z "$1" ]; then
    echo "‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–æ–º–µ–Ω!"
    echo "–ü—Ä–∏–º–µ—Ä: ./deploy-server.sh example.com"
    exit 1
fi

DOMAIN=$1
echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Freedom Hub –¥–ª—è –¥–æ–º–µ–Ω–∞: $DOMAIN"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -f "create_certificate_for_domain.sh" ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç create_certificate_for_domain.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
echo "üîê –°–æ–∑–¥–∞–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
./create_certificate_for_domain.sh $DOMAIN

# –ö–æ–ø–∏—Ä—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ ssl/
echo "üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
mkdir -p ssl
cp $DOMAIN.crt ssl/cert.pem
cp device.key ssl/key.pem

# –û–±–Ω–æ–≤–ª—è–µ–º nginx.conf –¥–ª—è –¥–æ–º–µ–Ω–∞
echo "‚öôÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ nginx.conf..."
sed -i "s/localhost/$DOMAIN/g" nginx.conf

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞..."
docker compose up --build -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
docker compose ps

echo ""
echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
echo "   - http://$DOMAIN (—Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS)"
echo "   - https://$DOMAIN (–æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ—Å—Ç—É–ø)"
echo ""
echo "‚ö†Ô∏è  –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:"
echo "   1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä"
echo "   2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç—ã 80 –∏ 443 –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ"
echo "   3. –î–ª—è –¥–æ–≤–µ—Ä–∏—è –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –¥–æ–±–∞–≤—å—Ç–µ rootCA.pem –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ"
echo ""
echo "üìù –ö–æ–º–∞–Ω–¥—ã:"
echo "   docker compose ps          - —Å—Ç–∞—Ç—É—Å"
echo "   docker compose logs -f     - –ª–æ–≥–∏"
echo "   docker compose down        - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞"
